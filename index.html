<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMDS Tabulation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        brand: {
                            gold: '#cdae8f',
                            dark: '#18181b', // Zinc 900
                            card: '#27272a', // Zinc 800
                            hover: '#3f3f46' // Zinc 700
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px -5px rgba(205, 174, 143, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body { @apply bg-gray-50 text-slate-900 transition-colors duration-300; }
        .dark body { @apply bg-brand-dark text-gray-100; }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { @apply bg-gray-300 dark:bg-gray-600 rounded-full; }
        ::-webkit-scrollbar-thumb:hover { @apply bg-brand-gold; }

        .input-modern { 
            @apply w-full bg-white dark:bg-black/20 border border-gray-200 dark:border-gray-700 
            rounded-xl px-4 py-3 text-sm font-medium focus:border-brand-gold focus:ring-1 focus:ring-brand-gold 
            outline-none transition-all placeholder-gray-400 dark:text-white; 
        }
        
        .card-modern {
            @apply bg-white dark:bg-brand-card border border-gray-100 dark:border-gray-700/50 
            rounded-2xl p-6 shadow-sm hover:shadow-md transition-all duration-300;
        }

        .btn-primary { 
            @apply bg-brand-gold text-black font-bold px-6 py-2.5 rounded-xl 
            hover:bg-white hover:text-brand-gold hover:shadow-glow border-2 border-brand-gold
            transition-all duration-300 flex items-center justify-center gap-2 text-sm uppercase tracking-wide; 
        }
        
        .nav-pill { 
            @apply px-8 py-3 rounded-xl text-sm font-extrabold text-black/60 
            hover:text-black hover:bg-black/5 transition-all whitespace-nowrap tracking-wide; 
        }
        .nav-pill.active { 
            @apply bg-black text-white shadow-xl scale-105; 
        }

        /* Fixed Overlay CSS to work with Tailwind hidden class */
        #projection-overlay {
            z-index: 9999;
        }
        .close-projection { 
            position: absolute; 
            top: 2rem; 
            right: 2rem; 
            opacity: 0.3; 
            cursor: pointer; 
            color: white; 
            font-size: 2rem; 
            transition: opacity 0.3s;
        }
        .close-projection:hover { opacity: 1; }
    </style>
</head>
<body class="dark h-screen flex flex-col overflow-hidden">

    <header id="main-header" class="h-20 shrink-0 bg-white/80 dark:bg-brand-dark/90 backdrop-blur-xl border-b border-gray-200 dark:border-gray-800 flex items-center justify-between px-4 md:px-8 z-50 hidden">
        <div class="flex items-center gap-4">
            <div class="relative group cursor-pointer w-10 h-10" onclick="document.getElementById('logo-upload').click()">
                <input type="file" id="logo-upload" hidden accept="image/*" onchange="app.uploadLogo(this)">
                
                <div id="default-logo" class="w-full h-full bg-gradient-to-br from-brand-gold to-yellow-600 rounded-xl flex items-center justify-center text-black font-extrabold text-xl shadow-lg transition-transform group-hover:scale-105">M</div>
                <img id="custom-logo" class="w-full h-full object-cover rounded-xl shadow-lg hidden transition-transform group-hover:scale-105" src="" alt="Logo">
                
                <div class="absolute inset-0 bg-black/60 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <i class="fas fa-camera text-white text-[10px]"></i>
                </div>
            </div>

            <div class="cursor-pointer group" onclick="app.returnToLanding()">
                <h1 class="font-bold text-lg tracking-tight leading-none text-gray-900 dark:text-white group-hover:text-brand-gold transition-colors">MMDS Tabulation</h1>
                <span id="header-category" class="text-xs text-brand-gold font-bold uppercase tracking-wider group-hover:text-white transition-colors">Select Category</span>
            </div>
        </div>
        
        <div class="flex items-center gap-3">
            <button id="theme-toggle" class="w-10 h-10 rounded-full border border-gray-200 dark:border-gray-700 flex items-center justify-center text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fas fa-sun dark:hidden"></i><i class="fas fa-moon hidden dark:block"></i>
            </button>
            <button id="switch-cat-btn" onclick="app.returnToLanding()" class="hidden text-xs font-bold text-gray-500 hover:text-brand-gold transition uppercase tracking-wider px-2 md:px-4">Exit</button>
            <button id="setup-btn" onclick="app.toggleModal('settings-modal')" class="hidden w-10 h-10 rounded-full bg-brand-gold text-black flex items-center justify-center hover:shadow-glow transition">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto relative bg-gray-50 dark:bg-black p-4 md:p-8">
        
        <div id="landing-page" class="absolute inset-0 z-40 bg-gray-50 dark:bg-brand-dark flex flex-col items-center justify-center p-6 overflow-y-auto">
            <div class="text-center max-w-2xl mx-auto mb-12 fade-in mt-10 md:mt-0" style="animation-delay: 0.1s;">
                <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight text-gray-900 dark:text-white">MMDS <span class="text-brand-gold">Tab</span></h1>
                <p class="text-lg text-gray-500 dark:text-gray-400">Professional Intra-School Championship Management System</p>
            </div>
            
            <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-6xl fade-in pb-10" style="animation-delay: 0.2s;">
                <!-- Categories will be injected here -->
            </div>
        </div>

        <div id="dashboard-content" class="hidden max-w-7xl mx-auto space-y-12">
            
            <div class="py-4 bg-gray-50 dark:bg-black transition-colors duration-300">
                <nav id="main-nav" class="flex overflow-x-auto gap-4 bg-brand-gold p-4 rounded-3xl shadow-xl shadow-brand-gold/10 no-scrollbar justify-start md:justify-center">
                    <button class="nav-pill active" data-tab="Overview" onclick="app.setTab('Overview')"><i class="fas fa-th-large mr-2"></i>Overview</button>
                    <button class="nav-pill" data-tab="Teams" onclick="app.setTab('Teams')"><i class="fas fa-users mr-2"></i>Teams</button>
                    <button class="nav-pill" data-tab="Adjudicators" onclick="app.setTab('Adjudicators')"><i class="fas fa-gavel mr-2"></i>Adjudicators</button>
                    <button class="nav-pill" data-tab="Motions" onclick="app.setTab('Motions')"><i class="fas fa-scroll mr-2"></i>Motions</button>
                    <button class="nav-pill" data-tab="Draw" onclick="app.setTab('Draw')"><i class="fas fa-random mr-2"></i>Draw</button>
                    <button class="nav-pill" data-tab="Logistics" onclick="app.setTab('Logistics')"><i class="fas fa-clipboard-list mr-2"></i>Ballots</button>
                    <button class="nav-pill" data-tab="Standings" onclick="app.setTab('Standings')"><i class="fas fa-chart-bar mr-2"></i>Standings</button>
                    <button class="nav-pill" data-tab="Speakers" onclick="app.setTab('Speakers')"><i class="fas fa-microphone mr-2"></i>Speakers</button>
                </nav>
            </div>

            <div id="Overview-tab" class="tab-pane fade-in">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1 bg-brand-gold text-black rounded-3xl p-10 relative overflow-hidden shadow-glow">
                        <div class="absolute -right-10 -top-10 w-48 h-48 bg-white opacity-20 rounded-full blur-3xl"></div>
                        <h3 class="font-bold text-xs uppercase tracking-widest mb-2 opacity-80">Tournament Status</h3>
                        <h2 class="text-6xl font-extrabold mb-8">Live</h2>
                        <div class="space-y-4 text-base font-bold opacity-90">
                            <div class="flex items-center justify-between border-b border-black/10 pb-3">
                                <span><i class="fas fa-users mr-2"></i>Registered Teams</span>
                                <span id="stats-teams" class="text-2xl">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span><i class="fas fa-layer-group mr-2"></i>Total Rounds</span>
                                <span id="stats-rounds" class="text-2xl">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2 card-modern flex items-center justify-center min-h-[350px] border-dashed border-2">
                        <div class="text-center text-gray-400">
                            <i class="fas fa-chart-line text-6xl mb-6 opacity-50"></i>
                            <p class="text-xl font-medium">Statistics will populate as rounds progress.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="Teams-tab" class="tab-pane hidden fade-in">
                <div class="card-modern mb-10 flex flex-col md:flex-row gap-8 items-center bg-gradient-to-r from-gray-50 to-white dark:from-brand-card dark:to-brand-card/50 p-8">
                    <div class="flex-grow w-full">
                        <h3 class="text-2xl font-bold mb-2 dark:text-white">Register Team</h3>
                        <p class="text-base text-gray-500">Add a new team to the tournament roster.</p>
                    </div>
                    <form id="add-team-form" class="flex w-full md:w-auto gap-4">
                        <input type="text" id="teamNameInput" required placeholder="Team Name..." class="input-modern md:w-96 text-base">
                        <button type="submit" class="btn-primary whitespace-nowrap text-base">Add Team</button>
                    </form>
                </div>
                <div id="teams-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
            </div>

            <div id="Adjudicators-tab" class="tab-pane hidden fade-in">
                <div class="card-modern mb-10 flex flex-col md:flex-row gap-8 items-center p-8">
                    <div class="flex-grow w-full">
                        <h3 class="text-2xl font-bold mb-2 dark:text-white">Adjudicators</h3>
                        <p class="text-base text-gray-500">Manage the judges pool.</p>
                    </div>
                    <form id="add-adj-form" class="flex w-full md:w-auto gap-4">
                        <input type="text" id="adjNameInput" required placeholder="Judge Name..." class="input-modern md:w-96 text-base">
                        <button type="submit" class="btn-primary text-base">Add Judge</button>
                    </form>
                </div>
                <ul id="adjs-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6"></ul>
            </div>

            <div id="Motions-tab" class="tab-pane hidden fade-in">
                <div id="motions-container" class="space-y-8 max-w-6xl mx-auto"></div>
            </div>

            <div id="Draw-tab" class="tab-pane hidden fade-in">
                <div class="card-modern mb-10 flex flex-col md:flex-row items-center gap-8 justify-between p-8">
                    <div>
                        <h3 class="text-2xl font-bold mb-2 dark:text-white">Draw Generation</h3>
                        <p class="text-base text-gray-500">Pair teams based on power-pairing rules.</p>
                    </div>
                    <div class="flex gap-6 w-full md:w-auto">
                        <select id="draw-round-select" class="input-modern w-48 text-base"></select>
                        <button id="generate-draw-btn" class="btn-primary text-base">Generate Draw</button>
                    </div>
                </div>
                <!-- Dynamic Draw Display Area -->
                <div id="draw-display" class="space-y-4"></div>
            </div>

            <div id="Logistics-tab" class="tab-pane hidden fade-in">
                <div class="card-modern mb-10 flex flex-col md:flex-row items-center gap-8 justify-between p-8">
                    <div>
                        <h3 class="text-2xl font-bold mb-2 dark:text-white">Ballot Entry</h3>
                        <p class="text-base text-gray-500">Enter scores and submit results for a round.</p>
                    </div>
                    <div class="flex gap-6 w-full md:w-auto">
                        <select id="logistics-round-select" class="input-modern w-48 text-base"></select>
                        <button id="load-ballots-btn" class="btn-primary text-base">Load Ballots</button>
                    </div>
                </div>
                <div id="ballots-container" class="space-y-10"></div>
            </div>

            <div id="Standings-tab" class="tab-pane hidden fade-in">
                <div class="card-modern overflow-hidden p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="bg-gray-50 dark:bg-black/40 text-sm font-bold uppercase text-gray-500 tracking-wider border-b border-gray-100 dark:border-gray-800">
                                <tr>
                                    <th class="px-10 py-6">Rank</th>
                                    <th class="px-10 py-6">Team Name</th>
                                    <th class="px-10 py-6 text-right">Wins</th>
                                    <th class="px-10 py-6 text-right">Total Speaks</th>
                                </tr>
                            </thead>
                            <tbody id="standings-body" class="divide-y divide-gray-100 dark:divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="Speakers-tab" class="tab-pane hidden fade-in">
                <div class="card-modern overflow-hidden p-0">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left whitespace-nowrap">
                            <thead class="bg-gray-50 dark:bg-black/40 text-sm font-bold uppercase text-gray-500 tracking-wider border-b border-gray-100 dark:border-gray-800">
                                <tr>
                                    <th class="px-10 py-6">Rank</th>
                                    <th class="px-10 py-6">Speaker Name</th>
                                    <th class="px-10 py-6 text-right">Rounds</th>
                                    <th class="px-10 py-6 text-right">Avg Speaks</th>
                                    <th class="px-10 py-6 text-right">Total Speaks</th>
                                </tr>
                            </thead>
                            <tbody id="speaker-standings-body" class="divide-y divide-gray-100 dark:divide-gray-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="password-modal" class="fixed inset-0 hidden z-[70] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="app.closePasswordModal()"></div>
        <div class="card-modern w-full max-w-md relative z-10 p-8 animate-fade-in text-center">
            <h3 class="text-2xl font-bold mb-2 dark:text-white">Security Check</h3>
            <p class="text-gray-500 mb-6">Please enter the administrator password.</p>
            <input type="password" id="password-input" class="input-modern text-center font-bold tracking-widest text-lg mb-6" placeholder="••••••••">
            <div class="flex justify-center gap-4">
                <button onclick="app.closePasswordModal()" class="px-6 py-2 rounded-xl border border-gray-200 dark:border-gray-700 font-bold text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition dark:text-white">Cancel</button>
                <button onclick="app.submitPassword()" class="btn-primary text-sm px-8">Confirm</button>
            </div>
        </div>
    </div>

    <div id="member-modal" class="fixed inset-0 hidden z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="app.toggleModal('member-modal')"></div>
        <div class="card-modern w-full max-w-lg relative z-10 p-10 animate-fade-in">
            <h3 class="text-3xl font-bold mb-8 dark:text-white">Manage Speakers</h3>
            <input type="hidden" id="modal-team-id">
            <div class="space-y-6 mb-10">
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Speaker 1</label><input id="mem1" class="input-modern"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Speaker 2</label><input id="mem2" class="input-modern"></div>
                <div><label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Speaker 3</label><input id="mem3" class="input-modern"></div>
            </div>
            <div class="flex justify-end gap-4">
                <button onclick="app.toggleModal('member-modal')" class="px-8 py-3 rounded-xl border border-gray-200 dark:border-gray-700 font-bold text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition dark:text-white">Cancel</button>
                <button onclick="app.saveMembers()" class="btn-primary text-sm">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 hidden z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="app.toggleModal('settings-modal')"></div>
        <div class="card-modern w-full max-w-xl relative z-10 p-10 animate-fade-in flex flex-col max-h-[85vh]">
            <h3 class="text-3xl font-bold mb-6 dark:text-white">Round Management</h3>
            
            <div class="flex-grow overflow-y-auto pr-2 mb-6">
                <div id="rounds-config-list" class="space-y-3">
                    </div>
            </div>
            
            <button onclick="app.addRoundConfig()" class="w-full py-3 border-2 border-dashed border-gray-600 rounded-xl text-gray-400 font-bold hover:text-brand-gold hover:border-brand-gold transition mb-4 uppercase tracking-wider text-xs">
                + Add Round
            </button>

            <button onclick="app.toggleModal('settings-modal')" class="w-full py-4 rounded-xl bg-gray-100 dark:bg-gray-800 font-bold text-base hover:bg-gray-200 dark:hover:bg-gray-700 transition dark:text-white">Done</button>
        </div>
    </div>

    <!-- New Category Modal -->
    <div id="category-modal" class="fixed inset-0 hidden z-[80] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="app.toggleModal('category-modal')"></div>
        <div class="card-modern w-full max-w-lg relative z-10 p-10 animate-fade-in">
            <h3 class="text-3xl font-bold mb-8 dark:text-white">New Tournament Edition</h3>
            <div class="space-y-6 mb-10">
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Edition Name</label>
                    <input id="cat-name" class="input-modern" placeholder="e.g. Senior Edition">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Subtitle</label>
                    <input id="cat-subtitle" class="input-modern" placeholder="e.g. High School Division">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 uppercase ml-1 mb-2 block">Icon (FontAwesome Class)</label>
                    <input id="cat-icon" class="input-modern" placeholder="e.g. fa-graduation-cap">
                    <p class="text-[10px] text-gray-500 mt-2">Examples: fa-school, fa-trophy, fa-star, fa-gavel</p>
                </div>
            </div>
            <div class="flex justify-end gap-4">
                <button onclick="app.toggleModal('category-modal')" class="px-8 py-3 rounded-xl border border-gray-200 dark:border-gray-700 font-bold text-sm hover:bg-gray-100 dark:hover:bg-gray-800 transition dark:text-white">Cancel</button>
                <button onclick="app.saveCategory()" class="btn-primary text-sm">Create Edition</button>
            </div>
        </div>
    </div>

    <div id="projection-overlay" class="fixed inset-0 z-[100] bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-zinc-800 via-zinc-950 to-black hidden flex-col justify-center items-center text-center p-8 md:p-20">
        <div class="close-projection" onclick="app.closeProjection()"><i class="fas fa-times"></i></div>
        <div id="projection-content" class="fade-in w-full max-w-6xl"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, serverTimestamp, updateDoc, runTransaction, getDocs, deleteDoc, writeBatch, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ================================================================
        // === IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION BELOW =========
        // ================================================================
        
        const firebaseConfig = {
          
        };

        const appId = 'mmds-tab-system'; // This is the folder name in the database

        // ================================================================
        // === END CONFIGURATION ==========================================
        // ================================================================

        const DELETE_PASS = "rubaba06";

        let db, auth;
        let passwordCallback = null;

        const state = { 
            teams: [], 
            rounds: [], 
            adjudicators: [], 
            categories: [], // New state for categories
            category: null,
            unsubscribers: [],
            authExpiry: 0 
        };

        const safeId = (str) => str.replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();
        const getPath = (col) => `artifacts/${appId}/public/data/${state.category.replace(/\s/g,'').toLowerCase()}${col}`;
        const getGlobalPath = (docId) => `artifacts/${appId}/public/data/Global/${docId}`;


        // --- UI COMPONENTS ---

        const UI = {
            teamCard: (t) => {
                const status = t.breakStatus || 'Open';
                let badgeClass = 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300';
                let actionBtn = `<button onclick="app.updateTeamStatus('${t.id}', 'Semis')" class="text-xs font-bold text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/20 px-3 py-1.5 rounded-lg border border-blue-200 dark:border-blue-800 transition">Promote to Semis</button>`;
                
                if(status === 'Semis') {
                    badgeClass = 'bg-purple-100 text-purple-700 border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800';
                    actionBtn = `
                        <div class="flex gap-2">
                            <button onclick="app.updateTeamStatus('${t.id}', 'Open')" class="text-xs font-bold text-gray-400 hover:text-red-500 transition px-2">Demote</button>
                            <button onclick="app.updateTeamStatus('${t.id}', 'Finals')" class="text-xs font-bold text-brand-gold hover:bg-brand-gold/10 px-3 py-1.5 rounded-lg border border-brand-gold/30 transition">Promote to Finals</button>
                        </div>`;
                } else if(status === 'Finals') {
                    badgeClass = 'bg-brand-gold text-black border-brand-gold font-extrabold';
                    actionBtn = `<button onclick="app.updateTeamStatus('${t.id}', 'Semis')" class="text-xs font-bold text-gray-400 hover:text-red-500 transition px-2">Demote</button>`;
                }

                return `
                <div class="card-modern group relative hover:border-brand-gold transition-colors p-8 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-6">
                        <h4 class="font-bold text-2xl dark:text-white truncate pr-4">${t.teamName}</h4>
                        <button class="delete-team-btn text-gray-300 hover:text-red-500 transition p-2 bg-gray-50 dark:bg-black/20 rounded-lg" data-id="${t.id}"><i class="fas fa-trash-alt"></i></button>
                    </div>
                    <div class="space-y-3 mb-8 flex-grow">
                        ${[0,1,2].map(i => `<div class="flex items-center text-sm ${t.members[i]?'text-gray-600 dark:text-gray-300':'text-gray-400 italic'}"><div class="w-2 h-2 rounded-full ${t.members[i]?'bg-brand-gold':'bg-gray-300 dark:bg-gray-700'} mr-4"></div>${t.members[i]||'Empty Slot'}</div>`).join('')}
                    </div>
                    
                    <div class="border-t border-gray-100 dark:border-gray-700 pt-4 mb-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-[10px] font-bold uppercase text-gray-400 tracking-wider">Tournament Status</span>
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border ${badgeClass}">${status}</span>
                        </div>
                        <div class="flex justify-end">
                            ${actionBtn}
                        </div>
                    </div>

                    <button class="manage-btn w-full py-4 rounded-xl border-2 border-dashed border-gray-200 dark:border-gray-700 text-xs font-extrabold text-gray-500 uppercase hover:text-brand-gold hover:border-brand-gold transition tracking-widest" 
                        data-id="${t.id}" data-raw='${JSON.stringify(t).replace(/'/g, "&#39;")}'>Manage Members</button>
                </div>`;
            },
            
            ballotRow: (mid, side, role, i, members, val, name) => `
                <div class="flex items-center gap-4 mb-4">
                    <span class="w-10 text-[10px] font-bold text-gray-400 uppercase tracking-wider">${role}</span>
                    <select id="${mid}_${side}_name_${i}" class="input-modern py-3 px-4 text-xs flex-grow h-12">
                        <option value="">Select Speaker</option>
                        ${members.map(m => `<option value="${m}" ${m===name?'selected':''}>${m||'Empty'}</option>`).join('')}
                    </select>
                    <input id="${mid}_${side}_score_${i}" type="number" class="score-input w-24 input-modern py-3 px-3 text-right font-mono font-bold text-lg h-12" data-mid="${mid}" placeholder="0" value="${val}">
                </div>`,

            roundConfigRow: (r, idx, total) => {
                let typeLabel = "Standard";
                let typeClass = "bg-blue-100 text-blue-700 border-blue-200";
                
                if (r.type === 'semis') {
                    typeLabel = "Semifinals";
                    typeClass = "bg-purple-100 text-purple-700 border-purple-200";
                } else if (r.type === 'finals') {
                    typeLabel = "Grand Finals"; 
                    typeClass = "bg-brand-gold text-black border-brand-gold";
                }

                const nameValue = r.name || `Round ${idx + 1}`;
                const isFirst = idx === 0;
                const isLast = idx === total - 1;

                return `
                <div class="flex items-center gap-3 bg-gray-50 dark:bg-black/20 p-3 rounded-xl border border-gray-100 dark:border-gray-700 transition-all hover:border-brand-gold/50">
                    <div class="flex flex-col gap-1 mr-2">
                        <button onclick="app.moveRound(${idx}, -1)" class="w-6 h-6 flex items-center justify-center rounded bg-gray-200 dark:bg-gray-800 hover:bg-brand-gold hover:text-black transition ${isFirst ? 'opacity-20 pointer-events-none' : ''}">
                            <i class="fas fa-chevron-up text-[10px]"></i>
                        </button>
                        <button onclick="app.moveRound(${idx}, 1)" class="w-6 h-6 flex items-center justify-center rounded bg-gray-200 dark:bg-gray-800 hover:bg-brand-gold hover:text-black transition ${isLast ? 'opacity-20 pointer-events-none' : ''}">
                            <i class="fas fa-chevron-down text-[10px]"></i>
                        </button>
                    </div>
                    
                    <input type="text" value="${nameValue}" 
                        onchange="app.updateRoundName(${idx}, this.value)"
                        class="flex-grow bg-transparent border-b border-transparent focus:border-brand-gold outline-none font-bold text-sm dark:text-white px-2 py-1"
                        placeholder="Round Name" />

                    <button onclick="app.toggleRoundType(${idx})" class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider border ${typeClass} transition-colors whitespace-nowrap">
                        ${typeLabel}
                    </button>
                    
                    <button onclick="app.deleteRoundConfig(${idx})" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-500/10 text-gray-400 hover:text-red-500 transition">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>`
            },

            categoryCard: (cat, idx) => `
                <div class="group relative bg-white dark:bg-brand-card p-10 rounded-3xl border border-gray-200 dark:border-gray-800 hover:border-brand-gold dark:hover:border-brand-gold cursor-pointer transition-all duration-300 hover:shadow-2xl hover:-translate-y-2 overflow-hidden" onclick="app.selectCategory('${cat.name}')">
                    <div class="absolute top-0 right-0 p-8 opacity-10 group-hover:opacity-20 transition-opacity transform group-hover:scale-110 duration-500">
                        <i class="fas ${cat.icon || 'fa-trophy'} text-9xl text-brand-gold"></i>
                    </div>
                    <div class="relative z-10">
                        <h2 class="text-3xl font-bold mb-3 text-gray-900 dark:text-white truncate pr-6">${cat.name}</h2>
                        <p class="text-gray-500 dark:text-gray-400 mb-8 truncate">${cat.subtitle || 'Tournament Edition'}</p>
                        <span class="inline-flex items-center text-brand-gold font-bold text-sm uppercase tracking-wider group-hover:translate-x-2 transition-transform">Enter Dashboard <i class="fas fa-arrow-right ml-2"></i></span>
                    </div>
                    <button onclick="event.stopPropagation(); app.deleteCategory(${idx})" class="absolute top-4 right-4 text-gray-300 hover:text-red-500 transition p-2 opacity-0 group-hover:opacity-100 z-20">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `,
            
            addCategoryCard: () => `
                <div onclick="app.toggleModal('category-modal')" class="group relative bg-gray-50 dark:bg-white/5 p-10 rounded-3xl border-2 border-dashed border-gray-300 dark:border-gray-700 hover:border-brand-gold hover:bg-white dark:hover:bg-brand-card cursor-pointer transition-all duration-300 flex flex-col items-center justify-center h-full min-h-[250px]">
                    <div class="w-16 h-16 rounded-full bg-gray-200 dark:bg-gray-800 flex items-center justify-center mb-4 group-hover:bg-brand-gold group-hover:text-black transition-colors">
                        <i class="fas fa-plus text-2xl text-gray-400 dark:text-gray-500 group-hover:text-black"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-400 dark:text-gray-500 group-hover:text-brand-gold transition-colors">Create New Edition</h3>
                </div>
            `
        };


        // --- APPLICATION CORE LOGIC ---

        const app = {
            init: async () => {
                try {
                    const appInstance = initializeApp(firebaseConfig);
                    db = getFirestore(appInstance);
                    auth = getAuth(appInstance);

                    document.getElementById('theme-toggle').onclick = () => document.body.classList.toggle('dark');

                    // Set up auth state listener
                    onAuthStateChanged(auth, u => {
                        if (u) {
                            app.loadInitialState();
                        }
                    });

                    // Initial authentication handling
                    let signedIn = false;
                    
                    // 1. Try Custom Token (if available in environment)
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                            signedIn = true;
                        } catch (e) {
                            console.warn("Custom token auth failed, trying anonymous fallback...", e);
                        }
                    } 
                    
                    // 2. Fallback to Anonymous if not signed in
                    if (!signedIn && !auth.currentUser) {
                        try {
                            await signInAnonymously(auth);
                        } catch (err) {
                            console.error("Anonymous auth failed:", err);
                            let msg = "Authentication failed. ";
                            if (err.code === 'auth/configuration-not-found' || err.code === 'auth/operation-not-allowed') {
                                msg += "Please go to the Firebase Console > Build > Authentication > Sign-in method, and ENABLE 'Anonymous' sign-in.";
                            } else if (err.code === 'auth/api-key-not-valid') {
                                msg += "Your API Key appears to be invalid. Check your firebaseConfig.";
                            } else {
                                msg += "Check console for details.";
                            }
                            alert(msg);
                            return; // Stop execution
                        }
                    }

                    app.setupEventListeners();
                    app.setPage('landing');
                } catch (e) {
                    console.error("Firebase Init Failed:", e);
                    alert("App Initialization Failed: " + e.message);
                }
            },

            setupEventListeners: () => {
                document.getElementById('add-team-form').onsubmit = app.createTeam;
                document.getElementById('add-adj-form').onsubmit = app.createAdj;
                document.getElementById('generate-draw-btn').onclick = app.generateDraw;
                document.getElementById('load-ballots-btn').onclick = app.loadBallots;
                
                // Add change listener to draw round select to load existing draw
                document.getElementById('draw-round-select').onchange = (e) => app.renderDrawDisplay(e.target.value);
                
                document.getElementById('password-input').addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') app.submitPassword();
                });
                
                // Central event delegation for dynamic buttons
                document.body.addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if(!btn) return;
                    if(btn.classList.contains('delete-team-btn')) app.deleteTeam(btn.dataset.id);
                    if(btn.classList.contains('manage-btn')) app.openMemberModal(btn.dataset.id, btn.dataset.raw);
                    if(btn.classList.contains('submit-ballot-btn')) app.submitBallot(btn.dataset);
                });

                document.body.addEventListener('input', e => {
                    if(e.target.classList.contains('score-input')) app.updateLiveCalc(e.target.dataset.mid);
                });
            },

            loadInitialState: () => {
                // Load global categories immediately
                app.loadCategories();

                // Persistence Logic: Restore State
                const savedCat = localStorage.getItem('mmds_category');
                if (savedCat) {
                    // We don't automatically jump to dashboard unless we confirm categories exist, 
                    // but we'll assume yes for speed or check later.
                    // Actually, let's just stay on landing if category is null, but if saved, try to load.
                    // For now, loadCategories handles the list. If user wants to click, they can.
                    // IF we want auto-redirect:
                    // app.selectCategory(savedCat);
                }
                
                app.loadBranding();
            },
            
            loadCategories: () => {
                onSnapshot(doc(db, getGlobalPath('Categories')), s => {
                    const defaults = [
                        { name: 'Senior Edition', subtitle: 'High School Division', icon: 'fa-graduation-cap' },
                        { name: 'Junior Edition', subtitle: 'Middle School Division', icon: 'fa-school' }
                    ];

                    const data = s.exists() ? s.data() : { list: defaults };
                    state.categories = Array.isArray(data.list) ? data.list : defaults;

                    // Init DB if empty
                    if(!s.exists()) {
                        setDoc(doc(db, getGlobalPath('Categories')), { list: defaults });
                    }

                    app.renderCategories();
                    
                    // Optional: Auto-select if saved and exists in list
                    const savedCat = localStorage.getItem('mmds_category');
                    if (savedCat && state.categories.find(c => c.name === savedCat) && !state.category) {
                         app.selectCategory(savedCat);
                         const savedTab = localStorage.getItem('mmds_tab') || 'Overview';
                         app.setTab(savedTab);
                    }
                });
            },
            
            renderCategories: () => {
                const grid = document.getElementById('categories-grid');
                if(!grid) return;
                
                const itemsHtml = state.categories.map((c, i) => UI.categoryCard(c, i)).join('');
                grid.innerHTML = itemsHtml + UI.addCategoryCard();
            },
            
            saveCategory: async () => {
                const name = document.getElementById('cat-name').value.trim();
                const sub = document.getElementById('cat-subtitle').value.trim();
                const icon = document.getElementById('cat-icon').value.trim();
                
                if(!name) return alert("Category Name is required");
                
                const newList = [...state.categories, { 
                    name: name, 
                    subtitle: sub, 
                    icon: icon || 'fa-trophy' 
                }];
                
                await setDoc(doc(db, getGlobalPath('Categories')), { list: newList });
                app.toggleModal('category-modal');
                // clear inputs
                document.getElementById('cat-name').value = '';
                document.getElementById('cat-subtitle').value = '';
                document.getElementById('cat-icon').value = '';
            },
            
            deleteCategory: (idx) => {
                 app.openPasswordPrompt(() => {
                     const newList = [...state.categories];
                     const removed = newList.splice(idx, 1);
                     
                     // If we deleted the current active category, go back to landing
                     if(state.category === removed[0].name) {
                         app.returnToLanding();
                     }
                     
                     setDoc(doc(db, getGlobalPath('Categories')), { list: newList });
                 });
            },

            // --- UI/NAVIGATION ---

            setPage: (p) => {
                const ids = ['landing-page', 'main-header', 'main-nav', 'dashboard-content'];
                ids.forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if(p === 'landing') {
                        el.classList.toggle('hidden', id !== 'landing-page');
                        if (id === 'landing-page') {
                            // When going to landing, we don't necessarily want to clear global listeners (like categories)
                            // But we should clear category-specific listeners
                            app.clearListeners();
                        }
                    } else {
                        el.classList.toggle('hidden', id === 'landing-page');
                    }
                });
                ['switch-cat-btn', 'setup-btn'].forEach(id => document.getElementById(id)?.classList.toggle('hidden', p !== 'dashboard'));
            },

            returnToLanding: () => {
                localStorage.removeItem('mmds_category');
                localStorage.removeItem('mmds_tab');
                state.category = null;
                app.setPage('landing');
            },

            selectCategory: (cat) => {
                state.category = cat;
                localStorage.setItem('mmds_category', cat);
                
                document.getElementById('header-category').textContent = cat;
                app.setPage('dashboard');
                if (!localStorage.getItem('mmds_tab')) app.setTab('Overview');
                
                if (auth.currentUser) app.startListeners();
            },

            setTab: (tab) => {
                const performSwitch = () => {
                    localStorage.setItem('mmds_tab', tab);

                    document.querySelectorAll('.nav-pill').forEach(l => l.classList.remove('active'));
                    const activeBtn = document.querySelector(`button[data-tab="${tab}"]`);
                    if(activeBtn) activeBtn.classList.add('active');
                    
                    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
                    const activePane = document.getElementById(`${tab}-tab`);
                    if(activePane) { activePane.classList.remove('hidden'); activePane.classList.add('fade-in'); }
                    
                    // Auto-load draw if switching to draw tab
                    if(tab === 'Draw') {
                        const drawSelect = document.getElementById('draw-round-select');
                        if(drawSelect && drawSelect.value) {
                            app.renderDrawDisplay(drawSelect.value);
                        }
                    }
                };

                if (tab === 'Logistics' || tab === 'Standings' || tab === 'Speakers') {
                    app.openPasswordPrompt(performSwitch);
                } else {
                    performSwitch();
                }
            },

            toggleModal: (id) => document.getElementById(id).classList.toggle('hidden'),


            // --- DATA / LISTENERS ---

            clearListeners: () => {
                state.unsubscribers.forEach(u => u());
                state.unsubscribers = [];
            },

            startListeners: () => {
                if(!db || !state.category) return;
                
                app.clearListeners();

                // 1. Teams Listener
                const sub1 = onSnapshot(collection(db, getPath('Teams')), snap => {
                    state.teams = [];
                    snap.forEach(d => state.teams.push({id: d.id, ...d.data()}));
                    
                    // Sort teams alphabetically for easier selection in dropdowns
                    state.teams.sort((a,b) => a.teamName.localeCompare(b.teamName));
                    
                    document.getElementById('teams-grid').innerHTML = state.teams.map(UI.teamCard).join('');
                    document.getElementById('stats-teams').innerText = state.teams.length;
                    
                    const sorted = [...state.teams].sort((a,b) => (b.wins||0)-(a.wins||0) || (b.totalSpeaks||0)-(a.totalSpeaks||0));
                    document.getElementById('standings-body').innerHTML = sorted.map((t,i) => `
                        <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition border-b border-gray-100 dark:border-gray-800">
                            <td class="px-10 py-6 font-bold text-gray-400 text-lg">#${i+1}</td>
                            <td class="px-10 py-6 font-bold text-lg text-gray-900 dark:text-white">${t.teamName}</td>
                            <td class="px-10 py-6 text-right font-mono font-medium text-lg">${t.wins||0}</td>
                            <td class="px-10 py-6 text-right font-mono text-gray-500 text-lg">${t.totalSpeaks||0}</td>
                        </tr>`).join('');
                });
                state.unsubscribers.push(sub1);

                // 2. Rounds Config Listener
                const sub2 = onSnapshot(doc(db, getPath('Metadata'), 'Rounds'), s => {
                    const defaultRounds = [
                        {type: 'standard'}, {type: 'standard'}, {type: 'standard'}, {type: 'standard'},
                        {type: 'semis'}, {type: 'finals'}
                    ];

                    const data = s.exists() ? s.data() : { list: defaultRounds };
                    state.rounds = Array.isArray(data.list) ? data.list : defaultRounds;
                    
                    // AUTO-CREATE if missing
                    if(!s.exists() || !Array.isArray(data.list)) {
                        setDoc(doc(db, getPath('Metadata'), 'Rounds'), { list: state.rounds });
                    }

                    document.getElementById('stats-rounds').innerText = state.rounds.length;
                    app.renderRoundList();

                    const opts = state.rounds.map((r, i) => {
                        const name = r.name || `Round ${i+1}`;
                        let label = name;
                        if (r.type === 'semis' && !r.name) label += ' (Semifinals)';
                        else if (r.type === 'finals' && !r.name) label += ' (Grand Finals)';
                        else if (!r.name) label += ' (Standard)';
                        return `<option value="${i+1}">${label}</option>`;
                    }).join('');
                    ['draw-round-select', 'logistics-round-select'].forEach(id => document.getElementById(id).innerHTML = opts);
                    
                    app.renderMotions();
                });
                state.unsubscribers.push(sub2);

                // 3. Adjudicators Listener
                const sub3 = onSnapshot(collection(db, getPath('Adjudicators')), snap => {
                    let html = '';
                    state.adjudicators = [];
                    snap.forEach(d => {
                        const adj = {id: d.id, ...d.data()};
                        state.adjudicators.push(adj);
                        html += `<li class="card-modern py-6 px-5 text-base font-bold text-gray-700 dark:text-gray-300 shadow-none text-center">${adj.name}</li>`;
                    });
                    document.getElementById('adjs-list').innerHTML = html;
                });
                state.unsubscribers.push(sub3);

                // 4. Speaker Standings Listener (derived from Results)
                const sub4 = onSnapshot(collection(db, getPath('Results')), snap => {
                    const speakerStats = {};

                    snap.forEach(doc => {
                        const r = doc.data();
                        const roundScores = {}; // Map name -> maxScore for THIS round

                        // Helper to process a side
                        const processSide = (side) => {
                            if (!r.speakers || !r.speakers[side]) return;
                            r.speakers[side].forEach(s => {
                                if (!s.name || !s.score) return;
                                const name = s.name.trim();
                                const score = Number(s.score);
                                
                                // If existing score for this speaker in this round, take max
                                if (roundScores[name]) {
                                    roundScores[name] = Math.max(roundScores[name], score);
                                } else {
                                    roundScores[name] = score;
                                }
                            });
                        };

                        processSide('prop');
                        processSide('opp');

                        // Aggregate into global stats
                        Object.keys(roundScores).forEach(name => {
                            if (!speakerStats[name]) speakerStats[name] = { total: 0, rounds: 0 };
                            speakerStats[name].total += roundScores[name];
                            speakerStats[name].rounds += 1;
                        });
                    });

                    const sortedSpeakers = Object.entries(speakerStats)
                        .map(([name, stat]) => ({name, ...stat}))
                        .sort((a, b) => b.total - a.total || b.rounds - a.rounds);

                    document.getElementById('speaker-standings-body').innerHTML = sortedSpeakers.map((s, i) => `
                        <tr class="hover:bg-gray-50 dark:hover:bg-white/5 transition border-b border-gray-100 dark:border-gray-800">
                            <td class="px-10 py-6 font-bold text-gray-400 text-lg">#${i+1}</td>
                            <td class="px-10 py-6 font-bold text-lg text-gray-900 dark:text-white">${s.name}</td>
                            <td class="px-10 py-6 text-right font-mono text-gray-500 text-lg">${s.rounds}</td>
                            <td class="px-10 py-6 text-right font-mono text-gray-500 text-lg">${(s.total/s.rounds).toFixed(2)}</td>
                            <td class="px-10 py-6 text-right font-mono font-bold text-brand-gold text-lg">${s.total}</td>
                        </tr>
                    `).join('');
                });
                state.unsubscribers.push(sub4);
            },


            // --- ADMIN / CONFIG ACTIONS (Teams, Adjs, Rounds) ---

            createTeam: async (e) => {
                e.preventDefault();
                const name = document.getElementById('teamNameInput').value.trim();
                if(!name) return;
                await setDoc(doc(db, getPath('Teams'), safeId(name)), { 
                    teamName: name, 
                    members: ['','',''], 
                    wins: 0, 
                    totalSpeaks: 0,
                    breakStatus: 'Open'
                });
                e.target.reset();
            },
            
            updateTeamStatus: (id, status) => updateDoc(doc(db, getPath('Teams'), id), { breakStatus: status }),
            deleteTeam: (id) => deleteDoc(doc(db, getPath('Teams'), id)),
            
            openMemberModal: (id, raw) => {
                const t = JSON.parse(raw);
                document.getElementById('modal-team-id').value = id;
                [1,2,3].forEach((n,i) => document.getElementById(`mem${n}`).value = t.members[i] || '');
                app.toggleModal('member-modal');
            },
            
            saveMembers: async () => {
                const id = document.getElementById('modal-team-id').value;
                const members = [1,2,3].map(n => document.getElementById(`mem${n}`).value);
                await updateDoc(doc(db, getPath('Teams'), id), { members });
                app.toggleModal('member-modal');
            },
            
            createAdj: async (e) => {
                e.preventDefault();
                await setDoc(doc(collection(db, getPath('Adjudicators'))), { name: document.getElementById('adjNameInput').value });
                e.target.reset();
            },

            renderRoundList: () => {
                document.getElementById('rounds-config-list').innerHTML = state.rounds.map((r, i) => UI.roundConfigRow(r, i, state.rounds.length)).join('');
            },

            addRoundConfig: () => {
                const newList = [...state.rounds, { type: 'standard', name: `Round ${state.rounds.length + 1}` }];
                updateDoc(doc(db, getPath('Metadata'), 'Rounds'), { list: newList });
            },

            deleteRoundConfig: (idx) => {
                app.openPasswordPrompt(() => {
                    const newList = [...state.rounds];
                    newList.splice(idx, 1);
                    state.rounds = newList; 
                    app.renderRoundList(); 

                    updateDoc(doc(db, getPath('Metadata'), 'Rounds'), { list: newList })
                        .catch(err => {
                            console.error("Deletion failed:", err);
                            alert("Failed to delete round from server. It may reappear on refresh.");
                        });
                });
            },

            moveRound: (index, direction) => {
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= state.rounds.length) return;

                const newList = [...state.rounds];
                [newList[index], newList[newIndex]] = [newList[newIndex], newList[index]];
                
                updateDoc(doc(db, getPath('Metadata'), 'Rounds'), { list: newList });
            },

            updateRoundName: (index, name) => {
                const newList = [...state.rounds];
                newList[index] = { ...newList[index], name: name };
                updateDoc(doc(db, getPath('Metadata'), 'Rounds'), { list: newList });
            },

            toggleRoundType: (idx) => {
                const types = ['standard', 'semis', 'finals'];
                const newList = [...state.rounds];
                const currentType = newList[idx].type || 'standard';
                const nextType = types[(types.indexOf(currentType) + 1) % types.length];
                
                newList[idx] = { ...newList[idx], type: nextType };
                updateDoc(doc(db, getPath('Metadata'), 'Rounds'), { list: newList });
            },


            // --- BRANDING ---

            uploadLogo: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64 = e.target.result;
                        const img = document.getElementById('custom-logo');
                        const def = document.getElementById('default-logo');
                        img.src = base64;
                        img.classList.remove('hidden');
                        def.classList.add('hidden');

                        const i = new Image();
                        i.onload = function() {
                            const canvas = document.createElement('canvas');
                            const scale = 200 / i.width;
                            canvas.width = 200;
                            canvas.height = i.height * scale;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(i, 0, 0, 200, canvas.height);
                            const optimizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                            
                            setDoc(doc(db, getGlobalPath('Branding')), { logo: optimizedBase64 }, {merge:true});
                        };
                        i.src = base64;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            loadBranding: () => {
                onSnapshot(doc(db, getGlobalPath('Branding')), doc => {
                    if (doc.exists() && doc.data().logo) {
                        const img = document.getElementById('custom-logo');
                        const def = document.getElementById('default-logo');
                        img.src = doc.data().logo;
                        img.classList.remove('hidden');
                        def.classList.add('hidden');
                    }
                });
            },


            // --- SECURITY / PASSWORD MODAL ---

            openPasswordPrompt: (cb) => {
                if (Date.now() < state.authExpiry) {
                    state.authExpiry = Date.now() + 120000;
                    cb();
                    return;
                }

                passwordCallback = cb;
                app.toggleModal('password-modal');
                const inp = document.getElementById('password-input');
                inp.value = '';
                setTimeout(() => inp.focus(), 100);
            },
            
            closePasswordModal: () => {
                document.getElementById('password-modal').classList.add('hidden');
                passwordCallback = null;
            },
            
            submitPassword: () => {
                const val = document.getElementById('password-input').value;
                if(val === DELETE_PASS) {
                    state.authExpiry = Date.now() + 120000;
                    
                    const actionToRun = passwordCallback;
                    app.closePasswordModal();
                    if(actionToRun) actionToRun();
                } else {
                    alert("Incorrect Password");
                    document.getElementById('password-input').value = '';
                    document.getElementById('password-input').focus();
                }
            },


            // --- MOTIONS / PROJECTION ---

            renderMotions: async () => {
                const snap = await getDocs(collection(db, getPath('Motions')));
                const data = {};
                snap.forEach(d => data[d.id] = d.data());
                
                let html = '';
                state.rounds.forEach((r, idx) => {
                    const i = idx + 1;
                    const m = data[`R${i}`] || {text: '', infoslide: '', locked: false};
                    const isLocked = !!m.locked;
                    
                    let roundLabel = r.name || `Round ${i}`;
                    if (!r.name) {
                         if (r.type === 'semis') roundLabel = "Semifinals";
                         else if (r.type === 'finals') roundLabel = "Grand Finals";
                    }

                    html += `
                    <div class="card-modern mb-10 p-10 relative group hover:border-brand-gold transition-colors">
                        <div class="flex justify-between items-center mb-8">
                            <span class="font-bold text-brand-gold uppercase tracking-wider text-sm">${roundLabel}</span>
                            <div class="flex gap-3">
                                <button onclick="app.toggleLock('R${i}', ${isLocked})" class="text-xs font-bold uppercase px-4 py-2 rounded-lg border ${isLocked ? 'text-red-500 border-red-500/30 bg-red-500/10' : 'text-emerald-500 border-emerald-500/30 bg-emerald-500/10'} hover:opacity-80 transition">
                                    ${isLocked ? '<i class="fas fa-lock mr-2"></i> Locked' : '<i class="fas fa-lock-open mr-2"></i> Visible'}
                                </button>
                                <button onclick="app.projectMotion('R${i}', 'info')" class="text-xs font-bold uppercase px-4 py-2 rounded-lg bg-blue-500/10 text-blue-500 border border-blue-500/30 hover:bg-blue-500/20 transition">
                                    <i class="fas fa-info-circle mr-2"></i> Info
                                </button>
                                <button onclick="app.projectMotion('R${i}', 'motion')" class="text-xs font-bold uppercase px-4 py-2 rounded-lg bg-white text-black hover:bg-gray-200 transition">
                                    <i class="fas fa-desktop mr-2"></i> Motion
                                </button>
                            </div>
                        </div>
                        
                        ${isLocked 
                            ? `<div class="w-full bg-black/40 border border-gray-700 rounded-xl h-64 flex flex-col items-center justify-center text-gray-500 mb-6">
                                     <i class="fas fa-lock text-4xl mb-4 opacity-50"></i>
                                     <p class="font-bold uppercase tracking-widest text-sm">Motion & Infoslide Hidden</p>
                                     <p class="text-xs mt-2 opacity-60">Unlock to view or edit</p>
                               </div>`
                            : `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-6">
                                     <div>
                                          <label class="block text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Motion Content</label>
                                          <textarea id="motion-R${i}" class="input-modern h-64 resize-none text-xl font-bold leading-relaxed p-6" placeholder="Enter motion here...">${m.text}</textarea>
                                     </div>
                                     <div>
                                          <label class="block text-xs font-bold text-gray-500 uppercase mb-3 tracking-wider">Infoslide Content</label>
                                          <textarea id="infoslide-R${i}" class="input-modern h-64 resize-none text-base font-medium leading-relaxed p-6 bg-gray-50 dark:bg-zinc-900/50 dark:text-gray-100 border-dashed" placeholder="Enter infoslide here...">${m.infoslide || ''}</textarea>
                                     </div>
                               </div>`
                        }

                        <div class="flex justify-end ${isLocked ? 'hidden' : ''}">
                            <button onclick="app.saveMotion('R${i}')" class="text-sm font-bold bg-brand-gold text-black px-8 py-3 rounded-xl hover:bg-white hover:text-brand-gold transition border-2 border-brand-gold">Save All</button>
                        </div>
                    </div>`;
                });
                document.getElementById('motions-container').innerHTML = html;
            },
            
            saveMotion: (id) => setDoc(doc(db, getPath('Motions'), id), {
                text: document.getElementById(`motion-${id}`).value,
                infoslide: document.getElementById(`infoslide-${id}`).value,
                locked: false
            }, {merge:true}),
            
            toggleLock: (id, locked) => {
                if (locked) {
                    app.openPasswordPrompt(() => {
                        setDoc(doc(db, getPath('Motions'), id), { locked: false }, {merge: true}).then(app.renderMotions);
                    });
                } else {
                    const textVal = document.getElementById(`motion-${id}`).value;
                    const infoVal = document.getElementById(`infoslide-${id}`).value;
                    setDoc(doc(db, getPath('Motions'), id), { text: textVal, infoslide: infoVal, locked: true }, {merge:true}).then(app.renderMotions);
                }
            },

            projectMotion: async (id, type = 'motion') => {
                app.openPasswordPrompt(async () => {
                    let contentText = "";
                    const docSnap = await getDoc(doc(db, getPath('Motions'), id));
                    
                    if (docSnap.exists()) {
                        const d = docSnap.data();
                        contentText = (type === 'motion' ? d.text : d.infoslide) || "";
                    } else {
                        const el = document.getElementById(`${type === 'motion' ? 'motion' : 'infoslide'}-${id}`);
                        if (el) contentText = el.value;
                    }

                    if (docSnap.exists() && docSnap.data().locked) {
                        await updateDoc(doc(db, getPath('Motions'), id), { locked: false });
                        app.renderMotions(); 
                    }

                    const overlay = document.getElementById('projection-overlay');
                    const content = document.getElementById('projection-content');
                    
                    const rNum = parseInt(id.replace('R', ''));
                    const rConfig = state.rounds[rNum - 1];
                    let baseTitle = rConfig.name || `Round ${rNum}`;
                    
                    if (!rConfig.name) {
                        if (rConfig.type === 'semis') baseTitle = "Semifinals";
                        else if (rConfig.type === 'finals') baseTitle = "Grand Finals";
                    }

                    const titleText = type === 'motion' ? baseTitle : `${baseTitle} - Infoslide`;
                    
                    content.innerHTML = `
                        <h1 class="text-brand-gold text-5xl font-extrabold uppercase mb-12 tracking-widest border-b-2 border-brand-gold/30 pb-6 inline-block">${titleText}</h1>
                        <div class="text-white text-4xl md:text-6xl font-bold leading-tight drop-shadow-2xl whitespace-pre-wrap">${contentText}</div>
                    `;
                    overlay.classList.remove('hidden');
                    overlay.classList.add('flex');
                });
            },

            closeProjection: () => {
                const overlay = document.getElementById('projection-overlay');
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            },

            // --- BALLOT / SCORING ---

            generateDraw: async () => {
                const rIdx = document.getElementById('draw-round-select').value - 1; 
                const rNum = rIdx + 1;
                const roundType = state.rounds[rIdx]?.type || 'standard';
                
                // --- JUNIOR ROUND 1 OVERRIDE ---
                if (state.category === 'Junior Edition' && rNum === 1) {
                    const getT = (name) => state.teams.find(t => t.teamName.trim() === name)?.id;
                    
                    // specific pairings requested
                    const fixed = [
                        {p: 'Team 4', o: 'Team 7'},
                        {p: 'Team 5', o: 'Team 8'},
                        {p: 'Team 6', o: 'Team 2'},
                        {p: 'Team 3', o: 'Team 1'}
                    ];

                    const pairings = [];
                    let missing = [];

                    fixed.forEach((m, i) => {
                        const pId = getT(m.p);
                        const oId = getT(m.o);
                        if(pId && oId) {
                            pairings.push({ prop: pId, opp: oId, room: `Room ${i+1}` });
                        } else {
                            if(!pId) missing.push(m.p);
                            if(!oId) missing.push(m.o);
                        }
                    });

                    if(missing.length > 0) {
                        alert(`Cannot generate fixed draw. Missing teams: ${missing.join(', ')}. Please register them exactly as named.`);
                        return;
                    }

                    await setDoc(doc(db, getPath('Draws'), `R${rNum}`), { pairings });
                    app.renderDrawDisplay(rNum);
                    return; 
                }
                // --- END OVERRIDE ---
                
                let pool = [...state.teams];
                
                if (roundType === 'semis') {
                    pool = pool.filter(t => t.breakStatus === 'Semis' || t.breakStatus === 'Finals');
                    if (pool.length === 0) return alert("No teams promoted to Semifinals yet! Go to Teams tab.");
                } else if (roundType === 'finals') {
                    pool = pool.filter(t => t.breakStatus === 'Finals');
                    if (pool.length === 0) return alert("No teams promoted to Finals yet! Go to Teams tab.");
                }

                if (rNum === 1) {
                    pool.sort(() => Math.random() - 0.5);
                } else {
                    pool.sort((a,b) => (b.wins-a.wins) || (b.totalSpeaks-a.totalSpeaks));
                }

                const pairings = [];
                for(let i=0; i<pool.length; i+=2) if(i+1 < pool.length) {
                    pairings.push({
                        prop: pool[i].id, 
                        opp: pool[i+1].id,
                        room: `Room ${pairings.length + 1}` // Default room name
                    });
                }
                
                await setDoc(doc(db, getPath('Draws'), `R${rNum}`), { pairings });
                app.renderDrawDisplay(rNum);
            },
            
            renderDrawDisplay: async (rNum) => {
                const drawDoc = await getDoc(doc(db, getPath('Draws'), `R${rNum}`));
                const display = document.getElementById('draw-display');
                
                if (!drawDoc.exists()) {
                    display.innerHTML = '<div class="text-center text-gray-400 italic">No draw generated for this round yet.</div>';
                    return;
                }
                
                const pairings = drawDoc.data().pairings;
                
                // Pre-generate options for performance
                const teamOptions = state.teams.map(t => `<option value="${t.id}">${t.teamName}</option>`).join('');
                
                display.innerHTML = pairings.map((p,i) => {
                    const roomName = p.room || `Room ${i+1}`;
                    
                    return `<div class="card-modern p-6 flex flex-col md:flex-row gap-6 justify-between items-center shadow-none mb-4 animate-fade-in">
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <span class="text-xs font-bold text-gray-400 uppercase tracking-widest whitespace-nowrap">Venue</span>
                            <input type="text" class="input-modern py-2 px-4 font-bold text-sm w-full md:w-48" value="${roomName}" 
                                onchange="app.updateDrawRoom(${rNum}, ${i}, this.value)" placeholder="Enter Room Name">
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-4 w-full md:w-auto flex-grow justify-center">
                            <select class="input-modern py-2 px-4 font-bold text-indigo-500 w-full md:w-64" onchange="app.updateDrawTeam(${rNum}, ${i}, 'prop', this.value)">
                                <option value="">Select Prop...</option>
                                ${state.teams.map(t => `<option value="${t.id}" ${t.id === p.prop ? 'selected' : ''}>${t.teamName}</option>`).join('')}
                            </select>
                            
                            <span class="text-gray-300 text-xs font-bold bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded">VS</span> 
                            
                            <select class="input-modern py-2 px-4 font-bold text-rose-500 w-full md:w-64" onchange="app.updateDrawTeam(${rNum}, ${i}, 'opp', this.value)">
                                <option value="">Select Opp...</option>
                                ${state.teams.map(t => `<option value="${t.id}" ${t.id === p.opp ? 'selected' : ''}>${t.teamName}</option>`).join('')}
                            </select>
                        </div>
                    </div>`;
                }).join('');
            },
            
            updateDrawRoom: async (rNum, idx, newVal) => {
                const path = getPath('Draws');
                const dRef = doc(db, path, `R${rNum}`);
                const snap = await getDoc(dRef);
                if(!snap.exists()) return;
                const pairings = snap.data().pairings;
                if(pairings[idx]) {
                    pairings[idx].room = newVal;
                    await updateDoc(dRef, { pairings });
                }
            },
            
            updateDrawTeam: async (rNum, idx, side, newId) => {
                const path = getPath('Draws');
                const dRef = doc(db, path, `R${rNum}`);
                const snap = await getDoc(dRef);
                if(!snap.exists()) return;
                
                const pairings = snap.data().pairings;
                if(pairings[idx]) {
                    pairings[idx][side] = newId;
                    await updateDoc(dRef, { pairings });
                }
            },

            loadBallots: async () => {
                const r = document.getElementById('logistics-round-select').value;
                const cont = document.getElementById('ballots-container');
                cont.innerHTML = '<div class="text-center py-12 text-gray-400"><i class="fas fa-circle-notch fa-spin text-3xl"></i></div>';
                
                const draw = await getDoc(doc(db, getPath('Draws'), `R${r}`));
                if(!draw.exists()) return cont.innerHTML = '<div class="text-center text-gray-500 py-12 font-medium">No draw found for this round.</div>';
                
                const resSnap = await getDocs(query(collection(db, getPath('Results')), where("round", "==", r)));
                const results = {};
                resSnap.forEach(d => results[d.id] = d.data());

                cont.innerHTML = draw.data().pairings.map((p, idx) => {
                    const mid = `${r}_${idx}`;
                    const saved = results[mid];
                    const t1 = state.teams.find(x => x.id===p.prop);
                    const t2 = state.teams.find(x => x.id===p.opp);
                    const roomLabel = p.room || `Room ${idx+1}`;
                    
                    const renderSide = (s, t, roles) => `
                        <div class="bg-gray-50 dark:bg-black/20 rounded-2xl p-8 border border-gray-100 dark:border-gray-800">
                            <div class="flex justify-between mb-6 pb-4 border-b border-gray-200 dark:border-gray-800">
                                <h4 class="font-bold text-${s==='prop'?'indigo-500':'rose-500'} text-lg">${t?.teamName || 'Unknown Team'}</h4>
                                <span id="${mid}_${s}_total" class="font-bold text-2xl dark:text-white">0</span>
                            </div>
                            <div id="${mid}_${s}_badge" class="h-8 mb-4"></div>
                            ${roles.map((role, i) => UI.ballotRow(mid, s, role, i, t?.members || [], saved?.speakers?.[s]?.[i]?.score||'', saved?.speakers?.[s]?.[i]?.name)).join('')}
                        </div>`;

                    const adjSelect = `
                        <div class="flex items-center gap-2">
                            <i class="fas fa-gavel text-gray-400"></i>
                            <select id="${mid}_adj" class="input-modern py-2 px-3 text-xs w-48 h-10 border-gray-300 dark:border-gray-700 bg-white dark:bg-black/40">
                                <option value="">Select Adjudicator...</option>
                                ${state.adjudicators.map(a => `<option value="${a.id}" ${saved?.adjudicator===a.id?'selected':''}>${a.name}</option>`).join('')}
                            </select>
                        </div>
                    `;

                    return `
                    <div class="card-modern overflow-hidden p-0 shadow-none">
                        <div class="px-8 py-5 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50/50 dark:bg-white/5">
                            <div class="flex items-center gap-6">
                                <h3 class="font-bold text-gray-400 text-sm uppercase tracking-wide">${roomLabel}</h3>
                                ${adjSelect}
                            </div>
                            <div class="flex items-center gap-4">
                                <span id="${mid}_msg" class="text-xs font-bold text-emerald-500 ${saved?'':'hidden'} flex items-center gap-2"><i class="fas fa-check-circle"></i> Submitted</span>
                                <button class="submit-ballot-btn btn-primary py-2 px-6 text-xs h-10" data-round="${r}" data-mid="${mid}" data-prop="${p.prop}" data-opp="${p.opp}">${saved?'Update':'Submit'}</button>
                            </div>
                        </div>
                        <div class="p-10 grid grid-cols-1 md:grid-cols-2 gap-10">
                            ${renderSide('prop', t1, ['PM','DPM','GW'])}
                            ${renderSide('opp', t2, ['LO','DLO','OW'])}
                        </div>
                    </div>`;
                }).join('');
                draw.data().pairings.forEach((_, i) => app.updateLiveCalc(`${r}_${i}`));
            },

            updateLiveCalc: (mid) => {
                let p = 0, o = 0;
                [0,1,2].forEach(i => {
                    p += Number(document.getElementById(`${mid}_prop_score_${i}`).value)||0;
                    o += Number(document.getElementById(`${mid}_opp_score_${i}`).value)||0;
                });
                document.getElementById(`${mid}_prop_total`).innerText = p;
                document.getElementById(`${mid}_opp_total`).innerText = o;
                
                const pBadge = document.getElementById(`${mid}_prop_badge`);
                const oBadge = document.getElementById(`${mid}_opp_badge`);
                if(p===0 && o===0) { pBadge.innerHTML=''; oBadge.innerHTML=''; return; }
                
                const win = `<span class="bg-emerald-500/10 text-emerald-500 text-xs font-bold px-3 py-1.5 rounded-lg border border-emerald-500/20 uppercase tracking-wider">Winning</span>`;
                const lose = `<span class="bg-rose-500/10 text-rose-500 text-xs font-bold px-3 py-1.5 rounded-lg border border-rose-500/20 uppercase tracking-wider">Losing</span>`;
                pBadge.innerHTML = p > o ? win : (o > p ? lose : '');
                oBadge.innerHTML = o > p ? win : (p > o ? lose : '');
            },

            submitBallot: async ({round, mid, prop, opp}) => {
                const getSide = (s) => [0,1,2].map(i => ({
                    name: document.getElementById(`${mid}_${s}_name_${i}`).value,
                    score: Number(document.getElementById(`${mid}_${s}_score_${i}`).value)||0
                }));
                const pData = getSide('prop'), oData = getSide('opp');
                const pTot = pData.reduce((a,b)=>a+b.score,0), oTot = oData.reduce((a,b)=>a+b.score,0);
                const adjId = document.getElementById(`${mid}_adj`).value;
                
                if(pTot===0 || oTot===0) return alert("Enter scores first.");

                try {
                    await setDoc(doc(db, getPath('Results'), mid), {
                        round, propId: prop, oppId: opp, propTotal: pTot, oppTotal: oTot,
                        winner: pTot > oTot ? prop : opp,
                        speakers: { prop: pData, opp: oData },
                        adjudicator: adjId,
                        timestamp: serverTimestamp()
                    });
                    
                    const snap = await getDocs(collection(db, getPath('Results')));
                    const stats = {};
                    state.teams.forEach(t => stats[t.id] = {wins:0, totalSpeaks:0});
                    snap.forEach(d => {
                        const r = d.data();
                        if(stats[r.propId]) { stats[r.propId].totalSpeaks += r.propTotal; if(r.winner===r.propId) stats[r.propId].wins++; }
                        if(stats[r.oppId]) { stats[r.oppId].totalSpeaks += r.oppTotal; if(r.winner===r.oppId) stats[r.oppId].wins++; }
                    });
                    const batch = writeBatch(db);
                    Object.keys(stats).forEach(id => batch.update(doc(db, getPath('Teams'), id), stats[id]));
                    await batch.commit();
                    
                    document.getElementById(`${mid}_msg`).classList.remove('hidden');
                } catch(e) { alert(e.message); }
            }
        };

        window.app = app;
        window.onload = app.init;
    </script>
</body>
</html>
